@{
    ViewData["Title"] = "‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º";
    var products = ViewBag.Products as List<InventoryTracker.Models.Product> ?? new List<InventoryTracker.Models.Product>();
    
    // Check if receipt data exists in TempData
    var hasReceipt = TempData.ContainsKey("ReceiptId");
    var receiptId = hasReceipt ? TempData["ReceiptId"] : null;
    var receiptDate = hasReceipt ? TempData["ReceiptDate"] : null;
    var receiptCustomer = hasReceipt ? TempData["ReceiptCustomer"] : null;
    var receiptPhone = hasReceipt ? TempData["ReceiptPhone"] : null;
    var receiptItems = hasReceipt ? TempData["ReceiptItems"]?.ToString() : null;
    var receiptTotal = hasReceipt ? TempData["ReceiptTotal"] : null;
}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="bi bi-cart-plus me-2"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º
                </h4>
            </div>
            <div class="card-body p-4">
                <form asp-action="Create" method="post" id="saleForm">
                    @Html.AntiForgeryToken()
                    
                    <h5 class="mb-3"><i class="bi bi-box me-1"></i>‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h5>
                    
                    @if (products.Any())
                    {
                        <div class="mb-3">
                            <input type="text" id="productSearch" class="form-control" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
                        </div>
                    }
                    
                    @if (products.Any())
                    {
                        <div class="card mb-4" style="border: 1px solid #dee2e6;">
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto; max-width: 100%;">
                                    <table class="table table-bordered mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 50px;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</th>
                                                <th style="width: 35%;">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                                <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th>
                                                <th>‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                                                <th>‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ü‡¶õ‡ßá</th>
                                                <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                    @foreach (var product in products)
                                    {
                                        <tr class="product-row">
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input product-check" 
                                                       data-product-id="@product.Id" 
                                                       data-product-name="@product.Name"
                                                       data-product-category="@product.Category"
                                                       data-product-price="@product.Price" />
                                            </td>
                                            <td><strong>@product.Name</strong></td>
                                            <td><span class="badge bg-info">@product.Category</span></td>
                                            <td class="text-success">‡ß≥@product.Price.ToString("N2")</td>
                                            <td>
                                                <span class="badge @(product.Quantity < 10 ? "bg-warning" : "bg-success")">
                                                    @product.Quantity
                                                </span>
                                            </td>
                                            <td style="width: 200px;">
                                                <div class="input-group input-group-sm">
                                                    <button type="button" class="btn btn-outline-danger qty-decrease" 
                                                            data-product-id="@product.Id" title="‡¶ï‡¶Æ‡¶æ‡¶®">
                                                        <i class="bi bi-dash-lg"></i>
                                                    </button>
                                                    <input type="number" class="form-control text-center product-qty" 
                                                           value="0" min="0" max="@product.Quantity" 
                                                           data-product-id="@product.Id" />
                                                    <button type="button" class="btn btn-outline-success qty-increase" 
                                                            data-product-id="@product.Id" data-max="@product.Quantity" title="‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                            <a asp-controller="Products" asp-action="Create" class="alert-link">‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                        </div>
                    }
                    
                    <!-- Live Bill Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light border-success" id="billCard" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h6>
                                </div>
                                <div class="card-body">
                                    <div id="billItemsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px;">
                                    </div>
                                    <hr />
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</span>
                                            <span id="billQty" class="badge bg-info">0</span>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between">
                                            <strong>‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</strong>
                                            <h5 class="mb-0"><span id="billTotal" class="text-success">‡ß≥0.00</span></h5>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-success" id="reviewBtn" @(products.Any() ? "" : "disabled")>
                                            <i class="bi bi-check-circle me-1"></i>‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
                                        </button>
                                        <a asp-action="Index" class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-left me-1"></i>‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bill Confirmation Modal -->
<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶¨‡¶ø‡¶≤ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-person me-1"></i>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)
                    </label>
                    <input type="text" id="modalCustomerName" name="customerName" class="form-control" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" />
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-telephone me-1"></i>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)
                    </label>
                    <input type="tel" id="modalPhoneNumber" name="phoneNumber" class="form-control" placeholder="‡ß¶‡ßßXXX-XXXXXX" />
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-sticky me-1"></i>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)
                    </label>
                    <input type="text" id="modalNotes" name="notes" class="form-control" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø" />
                </div>
                <hr />
                <h6 class="mb-3"><i class="bi bi-box me-2"></i>‡¶™‡¶£‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h6>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>‡¶™‡¶£‡ßç‡¶Ø</th>
                            <th class="text-end">‡¶¶‡¶æ‡¶Æ</th>
                            <th class="text-center">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                            <th class="text-end">‡¶Æ‡ßã‡¶ü</th>
                            <th class="text-center" style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="modalBillItems">
                    </tbody>
                </table>
                <hr />
                <div class="row">
                    <div class="col-6">
                        <span>‡¶Æ‡ßã‡¶ü ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</span>
                    </div>
                    <div class="col-6 text-end">
                        <span id="modalTotalQty" class="badge bg-info">0</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <strong>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</strong>
                    </div>
                    <div class="col-6 text-end">
                        <h5 class="mb-0"><span id="modalTotalPrice" class="text-success">‡ß≥0.00</span></h5>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button type="button" class="btn btn-success" id="confirmBtn">
                    <i class="bi bi-check-circle me-1"></i>‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Sales Receipt</h5>
            </div>
            <div class="modal-body">
                <!-- Receipt Card -->
                <div class="card border-0" id="receiptCard" style="background: #f8f9fa; border: 2px dashed #28a745;">
                    <div class="card-body p-4">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h4 class="mb-1">üõçÔ∏è Our Store</h4>
                            <p class="text-muted small mb-0">Sales Receipt</p>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Receipt Details -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Receipt No:</span>
                                <strong id="receiptNumber">-</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Date & Time:</span>
                                <strong id="receiptDateTime">-</strong>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Customer Info -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Customer:</span>
                                <strong id="receiptCustomer">-</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Phone:</span>
                                <strong id="receiptPhone">-</strong>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Items -->
                        <div class="mb-3">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-muted small fw-bold mb-1">
                                    <span style="flex: 1;">Product</span>
                                    <span style="width: 50px; text-align: center;">Qty</span>
                                    <span style="width: 80px; text-align: right;">Price</span>
                                </div>
                            </div>
                            <div id="receiptItems"></div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Total -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>Total Amount:</strong>
                                <h5 class="mb-0 text-success"><strong id="receiptTotal">‡ß≥0.00</strong></h5>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Footer -->
                        <div class="text-center text-muted small">
                            <p class="mb-1">Thank you for shopping with us!</p>
                            <p>See you again!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeReceiptBtn" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
                <button type="button" class="btn btn-success" id="printReceiptBtn" onclick="window.print();">
                    <i class="bi bi-printer me-1"></i>‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Check if receipt data exists and show receipt modal
        @if (hasReceipt && receiptId != null)
        {
            <text>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Receipt data found, preparing modal...');
            
            try {
                // Populate receipt modal with data
                const receiptNumberEl = document.getElementById('receiptNumber');
                const receiptDateEl = document.getElementById('receiptDateTime');
                const receiptCustomerEl = document.getElementById('receiptCustomer');
                const receiptPhoneEl = document.getElementById('receiptPhone');
                const receiptTotalEl = document.getElementById('receiptTotal');
                const itemsContainer = document.getElementById('receiptItems');
                
                if (receiptNumberEl) receiptNumberEl.textContent = '@receiptId';
                if (receiptDateEl) receiptDateEl.textContent = '@receiptDate';
                if (receiptCustomerEl) receiptCustomerEl.textContent = '@Html.Raw(receiptCustomer ?? "‡¶Ö‡¶§‡¶ø‡¶•‡¶ø")';
                if (receiptPhoneEl) receiptPhoneEl.textContent = '@Html.Raw(receiptPhone ?? "N/A")';
                if (receiptTotalEl) receiptTotalEl.textContent = '‡ß≥@receiptTotal';
                
                // Parse and display receipt items - items stored as JSON array in TempData
                const receiptItemsJson = @Html.Raw(receiptItems ?? "[]");
                console.log('Parsed items:', receiptItemsJson);
                
                if (itemsContainer && receiptItemsJson && Array.isArray(receiptItemsJson) && receiptItemsJson.length > 0) {
                    itemsContainer.innerHTML = '';
                    
                    receiptItemsJson.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'mb-2';
                        const itemName = item.Name || 'Unknown Product';
                        const itemQty = item.Qty || 0;
                        const itemTotal = parseFloat(item.Total || 0).toFixed(2);
                        
                        itemDiv.innerHTML = `
                            <div class="d-flex justify-content-between small">
                                <span style="flex: 1;">${itemName}</span>
                                <span style="width: 50px; text-align: center;">x${itemQty}</span>
                                <span style="width: 80px; text-align: right;">‡ß≥${itemTotal}</span>
                            </div>
                        `;
                        itemsContainer.appendChild(itemDiv);
                    });
                    console.log('Items rendered successfully');
                } else {
                    console.warn('No items to display or items is not an array');
                }
                
                // Show receipt modal
                const modalElement = document.getElementById('receiptModal');
                if (modalElement) {
                    const receiptModal = new bootstrap.Modal(modalElement);
                    receiptModal.show();
                    console.log('Receipt modal shown');
                } else {
                    console.error('Receipt modal element not found');
                }
            } catch (e) {
                console.error('Error in receipt processing:', e);
            }
            
            // Clear form on print close
            const closeBtn = document.getElementById('closeReceiptBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    // Clear the form
                    const form = document.getElementById('saleForm');
                    if (form) form.reset();
                    // Reset all checkboxes
                    document.querySelectorAll('.product-check').forEach(cb => cb.checked = false);
                    document.querySelectorAll('.product-qty').forEach(input => input.value = 0);
                    // Update bill display
                    if (typeof updateBill === 'function') {
                        updateBill();
                    }
                });
            }
            
            // Setup print functionality
            const printBtn = document.getElementById('printReceiptBtn');
            if (printBtn) {
                printBtn.addEventListener('click', function() {
                    window.print();
                });
            }
        });
            </text>
        }
        else
        {
            <text>
        console.log('No receipt data available');
            </text>
        }
        
        // Global billData to store current bill state
        let billData = { items: [] };
        
        // Update bill display
        function updateBill() {
            const items = [];
            let totalPrice = 0;
            let totalQty = 0;
            
            document.querySelectorAll('.product-check:checked').forEach(checkbox => {
                const productId = checkbox.getAttribute('data-product-id');
                const productName = checkbox.getAttribute('data-product-name');
                const productPrice = parseFloat(checkbox.getAttribute('data-product-price'));
                const qtyInput = document.querySelector(`.product-qty[data-product-id="${productId}"]`);
                const quantity = parseInt(qtyInput.value) || 0;
                
                if (quantity > 0) {
                    const itemTotal = productPrice * quantity;
                    items.push({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        quantity: quantity,
                        total: itemTotal
                    });
                    totalPrice += itemTotal;
                    totalQty += quantity;
                }
            });
            
            // Store in global billData
            billData.items = items;
            
            // Update bill card
            const billCard = document.getElementById('billCard');
            const billItemsList = document.getElementById('billItemsList');
            
            if (items.length > 0) {
                billCard.style.display = 'block';
                billItemsList.innerHTML = '';
                
                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'border-bottom pb-2 mb-2';
                    div.setAttribute('data-bill-item-index', index);
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>${item.name}</strong>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-sm btn-outline-danger bill-qty-decrease" data-item-index="${index}" title="‡¶ï‡¶Æ‡¶æ‡¶®">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="badge bg-secondary" style="display: inline-block; padding: 0.5em 0.75em; margin: 0 5px;">${item.quantity}</span>
                                <button type="button" class="btn btn-sm btn-outline-success bill-qty-increase" data-item-index="${index}" title="‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between text-muted small">
                            <span>‡ß≥${item.price.toFixed(2)} √ó ${item.quantity}</span>
                            <span class="text-dark fw-bold">‡ß≥${item.total.toFixed(2)}</span>
                        </div>
                    `;
                    billItemsList.appendChild(div);
                });
                
                document.getElementById('billQty').textContent = totalQty;
                document.getElementById('billTotal').textContent = '‡ß≥' + totalPrice.toFixed(2);
            } else {
                billCard.style.display = 'none';
            }
            
            return { items, totalPrice, totalQty };
        }
        
        // Event delegation for bill summary buttons
        document.getElementById('billItemsList').addEventListener('click', function(e) {
            const btn = e.target.closest('.bill-qty-increase, .bill-qty-decrease');
            if (!btn) return;
            
            e.preventDefault();
            const index = parseInt(btn.getAttribute('data-item-index'));
            const item = billData.items[index];
            
            if (btn.classList.contains('bill-qty-increase')) {
                const productId = item.id;
                const maxQty = parseInt(document.querySelector(`.product-qty[data-product-id="${productId}"]`)?.max) || 999;
                if (item.quantity < maxQty) {
                    item.quantity += 1;
                    item.total = item.price * item.quantity;
                    // Update main product qty input
                    document.querySelector(`.product-qty[data-product-id="${productId}"]`).value = item.quantity;
                    updateBill();
                }
            } else if (btn.classList.contains('bill-qty-decrease')) {
                const productId = item.id;
                if (item.quantity > 1) {
                    item.quantity -= 1;
                    item.total = item.price * item.quantity;
                    // Update main product qty input
                    document.querySelector(`.product-qty[data-product-id="${productId}"]`).value = item.quantity;
                    updateBill();
                } else if (item.quantity === 1) {
                    // When quantity reaches 0, uncheck the product and set quantity to 0
                    const checkbox = document.querySelector(`.product-check[data-product-id="${productId}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    document.querySelector(`.product-qty[data-product-id="${productId}"]`).value = 0;
                    updateBill();
                }
            }
        });
        
        // Function to update bill when modal quantities change
        function updateBillFromModal() {
            // Update main table quantities
            document.querySelectorAll('tr[data-item-index]').forEach((row, index) => {
                const qtyCell = row.querySelector('td:nth-child(3)');
                const totalCell = row.querySelector('td:nth-child(4)');
                const billData_current = billData.items[index];
                if (qtyCell && totalCell && billData_current) {
                    qtyCell.textContent = billData_current.quantity;
                    totalCell.textContent = '‡ß≥' + billData_current.total.toFixed(2);
                }
            });
            
            // Recalculate totals
            let totalQty = 0;
            let totalPrice = 0;
            billData.items.forEach(item => {
                totalQty += item.quantity;
                totalPrice += item.total;
            });
            
            // Update modal totals
            document.getElementById('modalTotalQty').textContent = totalQty;
            document.getElementById('modalTotalPrice').textContent = '‡ß≥' + totalPrice.toFixed(2);
        }
        
        // Increment/Decrement buttons
        document.querySelectorAll('.qty-increase').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.productId;
                const maxQty = parseInt(this.dataset.max);
                const input = document.querySelector(`.product-qty[data-product-id="${productId}"]`);
                if (input) {
                    let currentVal = parseInt(input.value) || 0;
                    if (currentVal < maxQty) {
                        input.value = currentVal + 1;
                        input.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
        
        document.querySelectorAll('.qty-decrease').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.productId;
                const input = document.querySelector(`.product-qty[data-product-id="${productId}"]`);
                if (input) {
                    let currentVal = parseInt(input.value) || 0;
                    if (currentVal > 0) {
                        input.value = currentVal - 1;
                        input.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
        
        // Event listeners for updates
        document.querySelectorAll('.product-check').forEach(checkbox => {
            checkbox.addEventListener('change', updateBill);
        });
        
        document.querySelectorAll('.product-qty').forEach(input => {
            input.addEventListener('change', function(e) {
                // Auto check/uncheck product checkbox based on quantity
                const productId = this.dataset.productId;
                const checkbox = document.querySelector(`.product-check[data-product-id="${productId}"]`);
                if (checkbox) {
                    checkbox.checked = parseInt(this.value) > 0;
                }
                updateBill();
            });
            input.addEventListener('keyup', function(e) {
                // Auto check/uncheck product checkbox based on quantity
                const productId = this.dataset.productId;
                const checkbox = document.querySelector(`.product-check[data-product-id="${productId}"]`);
                if (checkbox) {
                    checkbox.checked = parseInt(this.value) > 0;
                }
                updateBill();
            });
        });
        
        // Review button - show confirmation modal
        document.getElementById('reviewBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            updateBill(); // This populates billData.items
            
            if (billData.items.length === 0) {
                alert('‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®');
                return;
            }
            
            // Customer info inputs are now in modal - no need to populate
            const modalBillItems = document.getElementById('modalBillItems');
            modalBillItems.innerHTML = '';
            
            let totalQty = 0;
            let totalPrice = 0;
            
            billData.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td class="text-end">‡ß≥${item.price.toFixed(2)}</td>
                    <td class="text-center"><strong>${item.quantity}</strong></td>
                    <td class="text-end fw-bold">‡ß≥${item.total.toFixed(2)}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-danger modal-qty-decrease" data-item-index="${index}" title="‡¶ï‡¶Æ‡¶æ‡¶®">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success modal-qty-increase" data-item-index="${index}" title="‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </td>
                `;
                tr.setAttribute('data-item-index', index);
                modalBillItems.appendChild(tr);
                
                totalQty += item.quantity;
                totalPrice += item.total;
            });
            
            // Update modal totals
            document.getElementById('modalTotalQty').textContent = totalQty;
            document.getElementById('modalTotalPrice').textContent = '‡ß≥' + totalPrice.toFixed(2);
            
        // Event delegation for modal quantity buttons
        document.getElementById('modalBillItems').addEventListener('click', function(e) {
            const btn = e.target.closest('.modal-qty-increase, .modal-qty-decrease');
            if (!btn) return;
            
            const index = parseInt(btn.getAttribute('data-item-index'));
            const item = billData.items[index];
            const maxQty = document.querySelector(`.product-qty[data-product-id="${item.id}"]`)?.max || 999;
            
            if (btn.classList.contains('modal-qty-increase')) {
                if (item.quantity < parseInt(maxQty)) {
                    item.quantity += 1;
                    item.total = item.price * item.quantity;
                    // Update the modal row display
                    const row = document.querySelector(`tr[data-item-index="${index}"]`);
                    if (row) {
                        row.querySelector('td:nth-child(3)').textContent = item.quantity;
                        row.querySelector('td:nth-child(4)').textContent = '‡ß≥' + item.total.toFixed(2);
                    }
                    // Update modal totals
                    let totalQty = 0, totalPrice = 0;
                    billData.items.forEach(i => {
                        totalQty += i.quantity;
                        totalPrice += i.total;
                    });
                    document.getElementById('modalTotalQty').textContent = totalQty;
                    document.getElementById('modalTotalPrice').textContent = '‡ß≥' + totalPrice.toFixed(2);
                }
            } else if (btn.classList.contains('modal-qty-decrease')) {
                if (item.quantity > 1) {
                    item.quantity -= 1;
                    item.total = item.price * item.quantity;
                    // Update the modal row display
                    const row = document.querySelector(`tr[data-item-index="${index}"]`);
                    if (row) {
                        row.querySelector('td:nth-child(3)').textContent = item.quantity;
                        row.querySelector('td:nth-child(4)').textContent = '‡ß≥' + item.total.toFixed(2);
                    }
                    // Update modal totals
                    let totalQty = 0, totalPrice = 0;
                    billData.items.forEach(i => {
                        totalQty += i.quantity;
                        totalPrice += i.total;
                    });
                    document.getElementById('modalTotalQty').textContent = totalQty;
                    document.getElementById('modalTotalPrice').textContent = '‡ß≥' + totalPrice.toFixed(2);
                } else if (item.quantity === 1) {
                    // Remove the row when quantity reaches 0
                    const row = document.querySelector(`tr[data-item-index="${index}"]`);
                    if (row) {
                        row.remove();
                    }
                    // Remove from billData
                    billData.items.splice(index, 1);
                    // Update modal totals
                    let totalQty = 0, totalPrice = 0;
                    billData.items.forEach(i => {
                        totalQty += i.quantity;
                        totalPrice += i.total;
                    });
                    document.getElementById('modalTotalQty').textContent = totalQty;
                    document.getElementById('modalTotalPrice').textContent = '‡ß≥' + totalPrice.toFixed(2);
                    // Also uncheck the product in main form
                    const checkbox = document.querySelector(`.product-check[data-product-id="${item.id}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    document.querySelector(`.product-qty[data-product-id="${item.id}"]`).value = 0;
                }
            }
        });
            
            // Show modal
            new bootstrap.Modal(document.getElementById('billModal')).show();
        });
        
        // Confirm button - submit form
        document.getElementById('confirmBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            const form = document.getElementById('saleForm');
            
            if (!billData.items || billData.items.length === 0) {
                alert('‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            // Remove any existing hidden inputs first
            form.querySelectorAll('input[name="productIds"], input[name="quantities"], input[name="customerName"], input[name="phoneNumber"], input[name="notes"]').forEach(el => el.remove());
            
            // Add customer info from modal to form
            const customerName = document.getElementById('modalCustomerName').value;
            const phoneNumber = document.getElementById('modalPhoneNumber').value;
            const notes = document.getElementById('modalNotes').value;
            
            if (customerName) {
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'customerName';
                nameInput.value = customerName;
                form.appendChild(nameInput);
            }
            
            if (phoneNumber) {
                const phoneInput = document.createElement('input');
                phoneInput.type = 'hidden';
                phoneInput.name = 'phoneNumber';
                phoneInput.value = phoneNumber;
                form.appendChild(phoneInput);
            }
            
            if (notes) {
                const notesInput = document.createElement('input');
                notesInput.type = 'hidden';
                notesInput.name = 'notes';
                notesInput.value = notes;
                form.appendChild(notesInput);
            }
            
            // Add hidden inputs for products and quantities
            billData.items.forEach(item => {
                const pidInput = document.createElement('input');
                pidInput.type = 'hidden';
                pidInput.name = 'productIds';
                pidInput.value = item.id;
                form.appendChild(pidInput);
                
                const qtyInput = document.createElement('input');
                qtyInput.type = 'hidden';
                qtyInput.name = 'quantities';
                qtyInput.value = item.quantity;
                form.appendChild(qtyInput);
            });
            
            console.log('Submitting form with products:', billData.items);
            
            // Close confirmation modal and submit
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('billModal'));
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Submit the form
            form.submit();
        });
        
        // Product search by name or category
        document.getElementById('productSearch')?.addEventListener('keyup', function(e) {
            const searchText = e.target.value.trim().toLowerCase();
            document.querySelectorAll('.product-row').forEach(row => {
                const productName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const productCategory = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const matches = productName.includes(searchText) || productCategory.includes(searchText);
                row.style.display = matches ? '' : 'none';
            });
        });
    </script>
    
    <style>
        @@media print {
            body * {
                visibility: hidden;
            }
            
            #receiptCard, #receiptCard * {
                visibility: visible;
            }
            
            #receiptCard {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 80mm;
            }
            
            .modal, .modal-footer, .modal-header {
                display: none !important;
            }
        }
    </style>
}
