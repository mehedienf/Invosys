@model IEnumerable<InventoryTracker.Models.SalesTransaction>

@{
    ViewData["Title"] = "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º";
}

@Html.AntiForgeryToken()

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6 fw-bold text-primary mb-0">
            <i class="bi bi-cart-check me-2"></i>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º
        </h1>
        <p class="text-muted">‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
    </div>
    <a asp-action="Create" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º
    </a>
</div>

<!-- Search Section -->
<div class="card shadow mb-4">
    <div class="card-body">
        <label class="form-label"><i class="bi bi-search me-1"></i>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</label>
        <input type="text" id="saleSearch" class="form-control" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
    </div>
</div>

<div class="card shadow">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º #</th>
                        <th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>
                        <th>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                        <th>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</th>
                        <th class="text-end">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                        <th class="text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var sale in Model)
                        {
                            <tr class="sale-row">
                                <td>
                                    <span class="badge bg-primary">#@sale.Id</span>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(sale.CustomerName))
                                    {
                                        <i class="bi bi-person me-1"></i>@sale.CustomerName
                                    }
                                    else
                                    {
                                        <span class="text-muted">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(sale.PhoneNumber))
                                    {
                                        <i class="bi bi-telephone me-1"></i>@sale.PhoneNumber
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    <i class="bi bi-calendar me-1"></i>
                                    @sale.SaleDate.ToString("dd MMM yyyy, hh:mm tt")
                                </td>
                                <td>
                                    <span class="badge bg-info">@(sale.SalesItems?.Count ?? 0) ‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø</span>
                                </td>
                                <td class="text-end">
                                    <strong class="text-success fs-5">‡ß≥@sale.TotalAmount.ToString("N2")</strong>
                                </td>
                                <td class="text-center">
                                    <a asp-action="Details" asp-route-id="@sale.Id" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="bi bi-cart-x fs-1 text-muted"></i>
                                <p class="text-muted mt-2">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
                                <a asp-action="Create" class="btn btn-success btn-sm">
                                    <i class="bi bi-plus"></i> ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (Model != null && Model.Any())
{
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h6 class="text-muted">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</h6>
                    <h3 class="text-primary">@Model.Count()</h3>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</h6>
                    <h3 class="text-success">‡ß≥@Model.Sum(s => s.TotalAmount).ToString("N2")</h3>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">‡¶ó‡¶°‡¶º ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º</h6>
                    <h3 class="text-info">‡ß≥@Model.Average(s => s.TotalAmount).ToString("N2")</h3>
                </div>
            </div>
        </div>
    </div>
}

<!-- Receipt Modal -->
@{
    var hasReceipt = TempData.ContainsKey("ReceiptId");
    var receiptId = hasReceipt ? TempData["ReceiptId"] : null;
    var receiptDate = hasReceipt ? TempData["ReceiptDate"] : null;
    var receiptCustomer = hasReceipt ? TempData["ReceiptCustomer"] : null;
    var receiptPhone = hasReceipt ? TempData["ReceiptPhone"] : null;
    var receiptItems = hasReceipt ? TempData["ReceiptItems"]?.ToString() : null;
    var receiptTotal = hasReceipt ? TempData["ReceiptTotal"] : null;
}

<div class="modal fade @(hasReceipt ? "show" : "")" id="receiptModal" tabindex="-1" @(hasReceipt ? "style=\"display: block;\"" : "")>
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∞‡¶∏‡¶ø‡¶¶</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Receipt Card -->
                <div class="card border-0" id="receiptCard" style="background: #f8f9fa; border: 2px dashed #28a745;">
                    <div class="card-body p-4">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h4 class="mb-1">üõçÔ∏è ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h4>
                            <p class="text-muted small mb-0">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∞‡¶∏‡¶ø‡¶¶</p>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Receipt Details -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</span>
                                <strong id="receiptNumber">-</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡¶Ø‡¶º:</span>
                                <strong id="receiptDateTime">-</strong>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Customer Info -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï:</span>
                                <strong id="receiptCustomerName">-</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">‡¶´‡ßã‡¶®:</span>
                                <strong id="receiptPhoneNumber">-</strong>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Items -->
                        <div class="mb-3">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-muted small fw-bold mb-1">
                                    <span style="flex: 1;">‡¶™‡¶£‡ßç‡¶Ø</span>
                                    <span style="width: 50px; text-align: center;">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</span>
                                    <span style="width: 80px; text-align: right;">‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</span>
                                </div>
                            </div>
                            <div id="receiptItems"></div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Total -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</strong>
                                <h5 class="mb-0 text-success"><strong id="receiptTotalAmount">‡ß≥0.00</strong></h5>
                            </div>
                        </div>
                        
                        <hr class="my-2" />
                        
                        <!-- Footer -->
                        <div class="text-center text-muted small">
                            <p class="mb-1">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶!</p>
                            <p>‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeReceiptBtn" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
                <button type="button" class="btn btn-success" id="printReceiptBtn" onclick="window.print();">
                    <i class="bi bi-printer me-1"></i>‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
</div>

@if (hasReceipt)
{
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Populate receipt modal with data
                const receiptNumberEl = document.getElementById('receiptNumber');
                const receiptDateEl = document.getElementById('receiptDateTime');
                const receiptCustomerEl = document.getElementById('receiptCustomerName');
                const receiptPhoneEl = document.getElementById('receiptPhoneNumber');
                const receiptTotalEl = document.getElementById('receiptTotalAmount');
                const itemsContainer = document.getElementById('receiptItems');
                
                if (receiptNumberEl) receiptNumberEl.textContent = '@receiptId';
                if (receiptDateEl) receiptDateEl.textContent = '@receiptDate';
                if (receiptCustomerEl) receiptCustomerEl.textContent = '@Html.Raw(receiptCustomer ?? "‡¶Ö‡¶§‡¶ø‡¶•‡¶ø")';
                if (receiptPhoneEl) receiptPhoneEl.textContent = '@Html.Raw(receiptPhone ?? "N/A")';
                if (receiptTotalEl) receiptTotalEl.textContent = '‡ß≥@receiptTotal';
                
                // Parse and display receipt items
                const receiptItemsJson = @Html.Raw(receiptItems ?? "[]");
                
                if (itemsContainer && receiptItemsJson && Array.isArray(receiptItemsJson) && receiptItemsJson.length > 0) {
                    itemsContainer.innerHTML = '';
                    
                    receiptItemsJson.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'mb-2';
                        const itemName = item.Name || 'Unknown Product';
                        const itemQty = item.Qty || 0;
                        const itemTotal = parseFloat(item.Total || 0).toFixed(2);
                        
                        itemDiv.innerHTML = `
                            <div class="d-flex justify-content-between small">
                                <span style="flex: 1;">` + itemName + `</span>
                                <span style="width: 50px; text-align: center;">x` + itemQty + `</span>
                                <span style="width: 80px; text-align: right;">‡ß≥` + itemTotal + `</span>
                            </div>
                        `;
                        itemsContainer.appendChild(itemDiv);
                    });
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
                modal.show();
            } catch (error) {
                console.error('Error displaying receipt:', error);
            }
        });
    </script>
}

<script>

    // Real-time sales search by customer name or phone number
    document.getElementById('saleSearch')?.addEventListener('keyup', function(e) {
        const searchText = e.target.value.trim().toLowerCase();
        let visibleCount = 0;
        
        document.querySelectorAll('.sale-row').forEach(row => {
            const customerName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const phoneNumber = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const matches = customerName.includes(searchText) || phoneNumber.includes(searchText);
            row.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
        });
        
        // Show/hide no results message
        const tbody = document.querySelector('tbody');
        let noResultsRow = tbody.querySelector('.no-results-row');
        if (visibleCount === 0 && document.querySelectorAll('.sale-row').length > 0) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `<td colspan="7" class="text-center py-4"><i class="bi bi-inbox fs-1 text-muted"></i><p class="text-muted mt-2">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶ø‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p></td>`;
                tbody.appendChild(noResultsRow);
            }
        } else if (noResultsRow) {
            noResultsRow.remove();
        }
    });
</script>